trigger:
  - master
  - develop
  - feature/*

pool:
  vmImage: 'Ubuntu-16.04'

variables:
  imageName: rushbuild.azurecr.io/rushcontroller:latest #$(Build.SourceVersion)
  azureSubscriptionEndpoint: azure
  azureContainerRegistry: rushbuild

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '10.x'
    displayName: 'Install Node.js'

  - script: |
      npm install
      npm run build
    displayName: 'npm install and build'

#  - script: |
#      npm test
#    displayName: 'npm test'
#
#  - script: |
#      npm test
#    displayName: 'npm int test'

  - task: Docker@1
    displayName: Build docker image
    inputs:
      command: 'Build an image'
      dockerFile: Dockerfile
      imageName: $(imageName)
      containerregistrytype: Azure Container Registry
      azureSubscriptionEndpoint: $(azureSubscriptionEndpoint)
      azureContainerRegistry: $(azureContainerRegistry)

  - task: Docker@1
    displayName: login
    inputs:
      command: 'login'
      containerregistrytype: Azure Container Registry
      azureSubscriptionEndpoint: $(azureSubscriptionEndpoint)
      azureContainerRegistry: $(azureContainerRegistry)

  - script: |
      docker push $(imageName)
    displayName: 'docker push using script'

  - task: Docker@1
    displayName: Push Docker image
    inputs:
      command: 'Push an image'
      containerregistrytype: Azure Container Registry
      azureSubscriptionEndpoint: $(azureSubscriptionEndpoint)
      azureContainerRegistry: $(azureContainerRegistry)
      imageName: $(imageName)

#  - task: Docker@1
#    displayName: "Container registry login"
#    inputs:
#      command: login
#      azureSubscriptionEndpoint: $(azureSubscriptionEndpoint)
#      azureContainerRegistry: $(azureContainerRegistry)
#
#  - script: |
#      docker build -t $(dockerId).azurecr.io/$(imageName):$COMMIT_ID .
#      docker push $(dockerId).azurecr.io/$(imageName):$COMMIT_ID
#    displayName: 'docker'
#    env:
#      COMMIT_ID: $(Build.SourceVersion)